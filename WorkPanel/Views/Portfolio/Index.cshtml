@using System.Globalization
@using WorkPanel.Models.PortfolioViewModels
@model PortfolioViewModel
@{
    ViewData["Title"] = "Portfolio";    
}

<div class="index_body">
<div class="row" style="padding: 30px; background: whitesmoke; margin: 0px;">
    <div class="col-xs-6">
        <div class="row">
            <div class="col-md-5">
                <div class="row" style="">  
                    <div style="display: flex">
                        <h1>$<span style="font-weight: bold">@(Model.AssetsUnderManagement.ToString("n0", new CultureInfo("en-US")))</span></h1>
                        @{
                            var per = (Model.Assets.Sum(a => a.Price * a.Quantity) - Model.TotalInvested) / Model.TotalInvested;
                        }
                        @if (per >= 0)
                        {
                            <h3 style="padding-top: 10px;"><span style="font-weight: bold; color: #2BBF5C">+@(per.ToString("p", new CultureInfo("en-US")))</span></h3>
                        }
                        else if (double.IsNaN(per))
                        {

                        }
                        else
                        {
                            <h3 style="padding-top: 10px;"><span style="font-weight: bold; color: red">@(per.ToString("p", new CultureInfo("en-US")))</span></h3>
                        }
                    </div>
                </div>
                <div class="row" style="margin-top: -15px;">
                    <h5>Current Assets Under Management</h5>
                </div>
            </div>
            <div class="col-md-3" style="margin-top: 10px; margin-left: 5px;">
                   
            </div>
            <div class="col-md-3">
                <div class="row" style="">
                    <h1>$<span style="font-weight: bold">@((Model.NetAssetValue > 0 ? Model.NetAssetValue : 0).ToString("n2", new CultureInfo("en-US")))</span></h1>
                </div>
                <div class="row" style="margin-top: -15px; width: -moz-max-content;">
                    <h5>Current Net Asset Value</h5>
                </div>
            </div>
        </div>
        @if (!double.IsNaN(Model.NetAssetValue))
        {
            <div class="row">
                @if (Model.Nav1W != 0)
                {
                    <div class="col-md-4">
                        <div class="row">
                            <h3>
                                @{
                                    var navPercent = (Model.NetAssetValue - Model.Nav1W) / Model.NetAssetValue;
                                }
                                @if (navPercent > 0)
                                {
                                    <span style="font-weight: bold; color: #2BBF5C">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                                else
                                {
                                    <span style="font-weight: bold; color: red">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                            </h3>
                            <h5 style="margin-top: -5px;"><span>1W Change</span></h5>
                        </div>
                    </div>
                }
                @if (Model.Nav1M != 0)
                {
                    <div class="col-md-4">
                        <div class="row">
                            <h3>
                                @{
                                    var navPercent = (Model.NetAssetValue - Model.Nav1M) / Model.NetAssetValue;
                                }
                                @if (navPercent > 0)
                                {
                                    <span style="font-weight: bold; color: #2BBF5C">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                                else
                                {
                                    <span style="font-weight: bold; color: red">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                            </h3>
                            <h5 style="margin-top: -5px;"><span>1M Change</span></h5>
                        </div>
                    </div>
                }
                @if (Model.Nav3M != 0)
                {
                    <div class="col-md-4">
                        <div class="row">
                            <h3>
                                @{
                                    var navPercent = (Model.NetAssetValue - Model.Nav3M) / Model.NetAssetValue;
                                }
                                @if (navPercent > 0)
                                {
                                    <span style="font-weight: bold; color: #2BBF5C">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                                else
                                {
                                    <span style="font-weight: bold; color: red">@(navPercent.ToString("p", new CultureInfo("en-US")))</span>
                                }
                            </h3>
                            <h5 style="margin-top: -5px;"><span>3M Change</span></h5>
                        </div>
                    </div>
                }
            </div>
        }
        <div class="row">
            <div class="col-md-4">
                <div class="row">
                    <h3><span style="font-weight: bold; color: #2BBF5C">$@(Model.Acquisition.ToString("n0", new CultureInfo("en-US")))</span></h3>
                    <h5 style="margin-top: -5px;"><span>Acquisition Cost</span></h5>
                </div>
            </div>
            <div class="col-md-4">
                <div class="row">
                    @{
                        var profit = Model.AssetsUnderManagement - Model.TotalInvested;
                    }
                    @if (profit >= 0)
                    {
                        <h3><span style="font-weight: bold; color: #2BBF5C">$@(profit.ToString("n0", new CultureInfo("en-US")))</span></h3>
                        <h5 style="margin-top: -5px;"><span>Profit</span></h5>
                    }
                    else
                    {
                        <h3><span style="font-weight: bold; color: red">-$@Math.Abs(profit).ToString("n0", new CultureInfo("en-US"))</span></h3>
                        <h5 style="margin-top: -5px;"><span>Loss</span></h5>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-6">
        <canvas id="myChart" width="400" height="300"></canvas>
    </div>
</div>
<br/>
<div>
    <table class="table hover-table">
        <thead>
        <tr>
            <th>Asset</th>
            <th>Quantity</th>
            <th>Price/Price change</th>
            <th>Exposure</th>
            <th>Profit/Loss</th>
            <th style="text-align: end;">Weight, %</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var asset in Model.Assets)
        {
            asset.PointNumber = asset.Name == "USD" ? 2 : 4;

            <tr class="hover-tr">
                <td>
                    @if (asset.Name == "USD")
                    {
                        <span style="font-weight: bold; font-size: large;">@asset.Name</span>
                    }
                    else
                    {
                        <a data-toggle="modal" data-target="#modal-action-info" asp-action="Info" asp-route-id="@asset.Id">
                            <span style="font-weight: bold; font-size: large;">@asset.Name</span>
                        </a>
                    }
                </td>
                <td><span style="font-size: large;">@asset.Quantity.ToString("n"+asset.PointNumber, new CultureInfo("en-US"))</span> <span style="color: lightgray; font-size: large;">@asset.ShortName</span></td>
                <td>
                    @{
                        var percent = (asset.Price - asset.AveragePrice) / asset.Price;
                    }
                    @if (percent > 0)
                    {
                        <span style="color: #2BBF5C; font-size: large;">$@asset.Price.ToString("n2", new CultureInfo("en-US"))</span>
                        <span style="color: #2BBF5C; margin-left: 10px; font-size: small;">+@(percent.ToString("p2", new CultureInfo("en-US")))</span>
                    }
                    else
                    {
                        <span style="color: red; font-size: large;">$@asset.Price.ToString("n2", new CultureInfo("en-US"))</span>
                        <span style="color: red; margin-left: 10px; font-size: small;">@(percent.ToString("p2", new CultureInfo("en-US")))</span>
                    }
                </td>
                <td><span style="font-size: large;">$@((asset.Price * asset.Quantity).ToString("n2", new CultureInfo("en-US")))</span></td>
                <td>
                        
                    @if (asset.Profit >= 0)
                    { 

                        <span style="color: #2BBF5C; font-size: large;">$@(Math.Abs(asset.Quantity * asset.Price - asset.Quantity * asset.AveragePrice).ToString("N2", new CultureInfo("en-US")))</span>
                        <span style="color: #2BBF5C; margin-left: 10px; font-size: small;">+@(asset.Profit.ToString("p2", new CultureInfo("en-US")))</span>
                    }
                    else
                    {
                        <span style="color: red; font-size: large;">$@(Math.Abs(asset.Quantity * asset.Price - asset.Quantity * asset.AveragePrice).ToString("N2", new CultureInfo("en-US")))</span>
                        <span style="color: red; margin-left: 10px; font-size: small;">@(asset.Profit.ToString("p2", new CultureInfo("en-US")))</span>
                    }

                </td>
                <td style="text-align: end;"><span style="font-size: large;">@((Model.AssetsUnderManagement > 0 ? asset.Price * asset.Quantity / Model.AssetsUnderManagement : 0).ToString("P"))</span></td>
            </tr>
        }
        </tbody>
    </table>
</div>
</div>

<div id="add-modal" class="modal fade" role="dialog">
    <div class="modal-dialog" style="width: 400px;">    
        <div class="modal-content">
            <div style="height:30px; padding: 10px;">
                <button type="button" class="close" style="margin: 10px;" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                @await Html.PartialAsync("AddAsset")
            </div>
        </div>
    </div>
</div>

<div id="modal-action-info" class="modal fade" role="dialog">
    <div class="modal-dialog" style="width: 400px;">    
        <div class="modal-content">          
        </div>
    </div>
</div>



<script src="~/lib/chartjs/chart.js"></script>
<script>
    var ctx = $("#myChart");
    var myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec", "Jan", "Feb", "Mar"],
            datasets: [{
                label: 'Sample chart',
                data: [12, 19, 3, 5, 2, 3, 6, 3, 8, 2, 2, 6, 14, 2, 6, 4, 5, 6, 2, 45, 7, 2],

            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero:true
                    }
                }]
            },
            responsive: true
        }
    });
</script>